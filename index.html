<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- iOS Home Screen Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Link manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Viewport for proper scaling -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Prefix Quest</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>üè∞ PREFIX QUEST üè∞</h1>
        </div>
        
        <div class="game-content">
            <div class="stats-panel">
                <div class="stats-title">=== PLAYER STATS ===</div>
                <div class="stat-line">Level: <span id="level">1</span></div>
                <div class="stat-line">Gold: <span id="gold">0</span></div>
                <div class="stat-line">Strength: <span id="strength">10</span></div>
                <div class="stat-line">Intelligence: <span id="intelligence">10</span></div>
                <div class="stat-line">Armor: <span id="armor">cloth robe</span></div>
                <div class="stat-line">Weapon: <span id="weapon">wooden staff</span></div>
            </div>
            
            <div class="main-panel">
                <div id="game-area">
                    <div>Welcome to Prefix Quest!</div>
                    <div>Answer questions correctly to earn gold and buy gear!</div>
                    <br>
                    <button onclick="startGame()">Start Game</button>
                </div>
            </div>
        </div>
        
        <div class="game-footer">
            <button onclick="showShop()">Visit Shop</button>
            <button onclick="confirmNewGame()" id="new-game-btn">New Game</button>
        </div>
    </div>

    <script src="prefixes-with-desc.js"></script>
    <script src="equipment.js"></script>
    <script>
        class PrefixGame {
            constructor() {

            // Load enriched data
            this.prefixesWithDesc = (typeof PREFIXES_WITH_DESC !== 'undefined')
                ? PREFIXES_WITH_DESC
                : {};

            // Build basic prefix => definition map
            this.prefixes = {};
            this.definitionsToPrefix = {};

            for (const [prefix, info] of Object.entries(this.prefixesWithDesc)) {
                if (!info || typeof info.definition !== "string") continue;

                const def = info.definition.trim();
                if (!def) continue;

                this.prefixes[prefix] = def;

                if (!this.definitionsToPrefix[def]) {
                    this.definitionsToPrefix[def] = [];
                }
                this.definitionsToPrefix[def].push(prefix);
            }

            this.shopItems = EQUIPMENT;
            this.loadGame();
        }

            getExamplesForPrefix(prefix) {
                const entry = this.prefixesWithDesc[prefix];
                if (!entry) return [];
            
                // Prefer an array property named "examples"
                if (Array.isArray(entry.examples)) {
                    return entry.examples;
                }
            
                // Fallback if you happened to store a single example as "example"
                if (entry.example) {
                    return [entry.example];
                }
            
                return [];
            }

            getExamplesForDefinition(definition) {
                const prefixes = this.definitionsToPrefix[definition] || [];
                const allExamples = [];
            
                prefixes.forEach(p => {
                    this.getExamplesForPrefix(p).forEach(ex => {
                        if (!allExamples.includes(ex)) {
                            allExamples.push(ex);
                        }
                    });
                });
            
                return allExamples;
            }
            
            saveGame() {
                const gameState = {
                    player: this.player,
                    questionsAnswered: this.questionsAnswered,
                    questionPool: this.questionPool
                };
                localStorage.setItem('prefixGameSave', JSON.stringify(gameState));
            }
            
            loadGame() {
                const saved = localStorage.getItem('prefixGameSave');
                if (saved) {
                    const gameState = JSON.parse(saved);
                    this.player = gameState.player;
                    this.questionsAnswered = gameState.questionsAnswered || 0;
                    this.questionPool = gameState.questionPool || [];
                } else {
                    this.newGame();
                }
                if (this.questionPool.length === 0) this.refillQuestionPool();
                this.currentQuestion = null;
                this.currentAnswer = null;
                this.updateStats();
            }
            
            newGame() {
                this.player = {
                    level: 1, strength: 10, intelligence: 10, gold: 0,
                    armor: "cloth robe", weapon: "wooden staff", ownedItems: ["cloth robe", "wooden staff"]
                };
                this.questionsAnswered = 0;
                this.questionPool = [];
                this.refillQuestionPool();
                this.saveGame();
                this.updateStats();
            }
            
            refillQuestionPool() {
                this.questionPool = [];
                Object.entries(this.prefixes).forEach(([prefix, definition]) => {
                    this.questionPool.push({prefix, definition, type: "definition"});
                    this.questionPool.push({prefix, definition, type: "prefix"});
                });
                this.shuffleArray(this.questionPool);
                // Add extra randomization to prevent pattern recognition
                if (Math.random() < 0.5) this.shuffleArray(this.questionPool);

                console.log("prefixes", this.prefixes);
                console.log("questionPool", this.questionPool);
            }
            
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            getGoldReward() {
                return 10 + Math.floor(this.questionsAnswered / 5) * 8;
            }
            
            updateStats() {
                document.getElementById('level').textContent = this.player.level;
                document.getElementById('gold').textContent = this.player.gold;
                document.getElementById('strength').textContent = this.player.strength;
                document.getElementById('intelligence').textContent = this.player.intelligence;
                document.getElementById('armor').textContent = this.player.armor;
                document.getElementById('weapon').textContent = this.player.weapon;
            }
            
            generateQuestion() {
                if (this.questionPool.length === 0) {
                    this.refillQuestionPool();
                }
                
                const questionData = this.questionPool.pop();
                const {prefix, definition, type} = questionData;
                this.questionsAnswered++;
                
                if (type === "definition") {
                    this.currentQuestion = `What does '${prefix}' mean?`;
                    this.currentAnswer = {answer: definition, type: "definition"};
                } else {
                    this.currentQuestion = `What prefix means '${definition}'?`;
                    this.currentAnswer = {answer: definition, type: "prefix"};
                }
            }
            
            askQuestion() {
                this.generateQuestion();
                document.getElementById('game-area').innerHTML = `
                    <div class="question-counter">--- Question ${this.questionsAnswered} ---</div>
                    <div>${this.currentQuestion}</div>
                    <div class="input-area">
                        <input type="text" id="answer-input" placeholder="Your answer..." onkeypress="if(event.key==='Enter') game.submitAnswer()">
                        <button onclick="game.submitAnswer()">Submit</button>
                        <button onclick="game.skipQuestion()">I Don't Know</button>
                    </div>
                `;
                document.getElementById('answer-input').focus();
            }
            
            submitAnswer() {
                const userAnswer = document.getElementById('answer-input').value.trim().toLowerCase();
                if (!userAnswer) return;
                
                let correct = false;
                const {answer, type} = this.currentAnswer;
                
                if (type === "definition") {
                    correct = answer.toLowerCase().includes(userAnswer) || userAnswer.includes(answer.toLowerCase());
                } else {
                    const validPrefixes = this.definitionsToPrefix[answer];
                    correct = validPrefixes.includes(userAnswer);
                }
                
                let resultText;
                if (correct) {
                    const goldReward = this.getGoldReward();
                    this.player.gold += goldReward;
                    resultText = `<div class="correct">‚úì Correct! +${goldReward} gold</div>`;
                } else {
                    if (type === "definition") {
                        const examples = this.getExamplesForDefinition(answer);
                        resultText = `<div class="incorrect">
                            ‚úó Wrong! The answer was: ${answer}
                            ${examples.length ? `<div class="examples">Example words: ${examples.join(', ')}</div>` : ''}
                        </div>`;
                    } else {
                        const validPrefixes = this.definitionsToPrefix[answer];
                        const examples = this.getExamplesForPrefix(validPrefixes[0]);
                        resultText = `<div class="incorrect">
                            ‚úó Wrong! Valid answers: ${validPrefixes.join(', ')}
                            ${examples.length ? `<div class="examples">Example words: ${examples.join(', ')}</div>` : ''}
                        </div>`;
                    }
                }
                
                this.updateStats();
                this.saveGame();
                
                document.getElementById('game-area').innerHTML = `
                    <div class="question-counter">--- Question ${this.questionsAnswered} ---</div>
                    <div>${this.currentQuestion}</div>
                    <div>Your answer: ${userAnswer}</div>
                    ${resultText}
                    <div class="input-area">
                        <button onclick="game.nextQuestion()">Continue</button>
                    </div>
                `;
                
                if (this.questionsAnswered % 10 === 0) {
                    setTimeout(() => this.offerBossFight(), 1000);
                }
            }

            
            skipQuestion() {
                const {answer, type} = this.currentAnswer;
                
                let resultText;
                if (type === "definition") {
                    const examples = this.getExamplesForDefinition(answer);
                    resultText = `<div class="incorrect">
                        Skipped! The answer was: ${answer}
                        ${examples.length ? `<div class="examples">Example words: ${examples.join(', ')}</div>` : ''}
                    </div>`;
                } else {
                    const validPrefixes = this.definitionsToPrefix[answer];
                    const examples = this.getExamplesForPrefix(validPrefixes[0]);
                    resultText = `<div class="incorrect">
                        Skipped! Valid answers: ${validPrefixes.join(', ')}
                        ${examples.length ? `<div class="examples">Example words: ${examples.join(', ')}</div>` : ''}
                    </div>`;
                }
                
                this.saveGame();
                
                document.getElementById('game-area').innerHTML = `
                    <div class="question-counter">--- Question ${this.questionsAnswered} ---</div>
                    <div>${this.currentQuestion}</div>
                    ${resultText}
                    <div class="input-area">
                        <button onclick="game.nextQuestion()">Continue</button>
                    </div>
                `;
                
                if (this.questionsAnswered % 10 === 0) {
                    setTimeout(() => this.offerBossFight(), 1000);
                }
            }

            
            nextQuestion() {
                this.askQuestion();
            }
            
            offerBossFight() {
                document.getElementById('game-area').innerHTML = `
                    <div>You've answered ${this.questionsAnswered} questions!</div>
                    <div>Ready for a boss fight?</div>
                    <div class="input-area">
                        <button onclick="game.fightBoss()">Fight Boss</button>
                        <button onclick="game.askQuestion()">Continue Questions</button>
                    </div>
                `;
            }
            
            fightBoss() {
                const bossPower = this.player.level * 20 + Math.floor(this.player.level / 3) * 10;
                const playerPower = this.player.strength + this.player.intelligence;
                
                document.getElementById('game-area').innerHTML = `
                    <div>=== BOSS FIGHT ===</div>
                    <div>A Level ${this.player.level} boss appears!</div>
                    <br>
                    <div>Boss Power: ${bossPower}</div>
                    <div>Your Power: ${playerPower}</div>
                    <div class="input-area">
                        <button onclick="game.resolveBattle(${bossPower}, ${playerPower})">Battle!</button>
                    </div>
                `;
            }
            
            resolveBattle(bossPower, playerPower) {
                if (playerPower >= bossPower) {
                    this.player.level++;
                    this.player.gold += 50;
                    this.updateStats();
                    this.saveGame();
                    document.getElementById('game-area').innerHTML = `
                        <div class="correct">‚öîÔ∏è VICTORY! ‚öîÔ∏è</div>
                        <div>You defeated the boss!</div>
                        <div>Level up! Now level ${this.player.level}</div>
                        <div>+50 bonus gold!</div>
                        <div class="input-area">
                            <button onclick="game.askQuestion()">Continue</button>
                        </div>
                    `;
                } else {
                    document.getElementById('game-area').innerHTML = `
                        <div class="incorrect">üíÄ DEFEAT! üíÄ</div>
                        <div>You need ${bossPower - playerPower} more power to win.</div>
                        <div>Buy better gear and try again!</div>
                        <div class="input-area">
                            <button onclick="showShop()">Visit Shop</button>
                            <button onclick="game.askQuestion()">Continue Questions</button>
                        </div>
                    `;
                }
            }
            
            showShop() {
                const maxAffordable = this.player.gold;
                const nextTierLimit = maxAffordable + 100;
                
                let shopHTML = '<div>=== SHOP ===</div><br>';
                let hasItems = false;
                
                Object.entries(this.shopItems).forEach(([item, stats]) => {
                    if (stats.cost <= nextTierLimit && !this.player.ownedItems.includes(item)) {
                        hasItems = true;
                        const affordable = stats.cost <= this.player.gold;
                        const symbol = affordable ? '‚úì' : '‚úó';
                        const className = affordable ? 'affordable' : 'unaffordable';
                        shopHTML += `<div class="shop-item ${className}" onclick="game.buyItem('${item}')">
                            ${symbol} ${item}: ${stats.cost} gold (+${stats.strength} STR, +${stats.intelligence} INT)
                        </div>`;
                    }
                });
                
                if (!hasItems) {
                    shopHTML += '<div>No new items available. You own everything in your price range!</div><br>';
                }
                
                shopHTML += `<div class="input-area">
                    <button onclick="game.askQuestion()">Leave Shop</button>
                </div>`;
                
                document.getElementById('game-area').innerHTML = shopHTML;
            }
            
            buyItem(itemName) {
                const item = this.shopItems[itemName];
                if (this.player.gold >= item.cost) {
                    this.player.gold -= item.cost;
                    this.player.strength += item.strength;
                    this.player.intelligence += item.intelligence;
                    this.player.ownedItems.push(itemName);
                    
                    if (item.type === "armor") {
                        this.player.armor = itemName;
                    } else {
                        this.player.weapon = itemName;
                    }
                    
                    this.updateStats();
                    this.saveGame();
                    
                    document.getElementById('game-area').innerHTML = `
                        <div class="correct">Purchased ${itemName}!</div>
                        <div class="input-area">
                            <button onclick="game.showShop()">Continue Shopping</button>
                            <button onclick="game.askQuestion()">Leave Shop</button>
                        </div>
                    `;
                } else {
                    document.getElementById('game-area').innerHTML = `
                        <div class="incorrect">Not enough gold! Need ${item.cost} gold.</div>
                        <div class="input-area">
                            <button onclick="game.showShop()">Back to Shop</button>
                        </div>
                    `;
                }
            }
        }
        
        let game = new PrefixGame();
        
        function startGame() {
            game.askQuestion();
        }
        
        function showShop() {
            game.showShop();
        }
        
        function confirmNewGame() {
            const btn = document.getElementById('new-game-btn');
            if (btn.textContent === 'New Game') {
                btn.textContent = 'Start a new game? This will reset all progress.';
                btn.onclick = () => newGame();
                setTimeout(() => {
                    if (btn.textContent !== 'New Game') {
                        btn.textContent = 'New Game';
                        btn.onclick = () => confirmNewGame();
                    }
                }, 5000);
            }
        }
        
        function newGame() {
            game.newGame();
            document.getElementById('game-area').innerHTML = `
                <div class="correct">üéÆ NEW GAME STARTED! üéÆ</div>
                <div>All progress has been reset. Ready for a fresh adventure?</div>
                <div class="input-area">
                    <button onclick="startGame()">Start Playing</button>
                </div>
            `;
            const btn = document.getElementById('new-game-btn');
            btn.textContent = 'New Game';
            btn.onclick = () => confirmNewGame();
        }
    </script>
</body>
</html>
